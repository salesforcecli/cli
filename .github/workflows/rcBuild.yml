name: RC
on:
  release:
    types: [published]

jobs:
  npm-release:
    uses: salesforcecli/github-workflows/.github/workflows/npmPublish.yml@main
    secrets: inherit
    with:
      tag: latest-rc
      ctc: true
      githubTag: ${{ github.event.release.tag_name }}

  pack-verify-upload-tarballs:
    needs: [npm-release]
    uses: salesforcecli/github-workflows/.github/workflows/tarballs.yml@main
    with:
      upload: true
      cli: sf
      version: ${{ github.event.release.tag_name }}
      channel: stable-rc
    secrets: inherit

  archives-verify:
    runs-on: ubuntu-latest
    needs: [pack-verify-upload-tarballs]
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: latest
          cache: npm
      - run: npm install -g @salesforce/plugin-release-management --omit=dev
      - run: sf-release cli:versions:inspect -c stable-rc -l archive --cli sf

  pack-upload-mac:
    needs: [pack-verify-upload-tarballs]
    uses: salesforcecli/github-workflows/.github/workflows/packUploadMac.yml@main
    with:
      cli: sf
      version: ${{ github.event.release.tag_name }}
      channel: stable-rc
    secrets: inherit

  pack-upload-win:
    needs: [pack-verify-upload-tarballs]
    uses: salesforcecli/github-workflows/.github/workflows/packUploadWindows.yml@main
    with:
      cli: sf
      version: ${{ github.event.release.tag_name }}
      channel: stable-rc
    secrets: inherit

  Post-RC-to-Slack:
    runs-on: ubuntu-latest
    needs: [pack-verify-upload-tarballs, npm-release, pack-upload-win, pack-upload-mac]
    steps:
      - name: Announce RC Workflow
        id: slack
        uses: slackapi/slack-github-action@v1.21.0
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_RC_ANNOUNCEMENT_WORKFLOW_WEBHOOK }}
        with:
          payload: |
            {
              "cli": "sf",
              "npm-package": "@salesforce/cli",
              "version": "${{ github.event.release.tag_name }}"
            }

  next-release:
    runs-on: ubuntu-latest
    needs: [pack-verify-upload-tarballs, npm-release, pack-upload-win, pack-upload-mac]
    steps:
      - uses: actions/checkout@v3
        with:
          token: ${{ secrets.SF_CLI_BOT_GITHUB_TOKEN }}
      - uses: actions/setup-node@v3
        with:
          node-version: latest
          cache: npm
      - uses: salesforcecli/github-workflows/.github/actions/gitConfig@main
      - run: npm install -g @salesforce/plugin-release-management --omit=dev
      - run: sf-release cli:latestrc:build --no-resolutions --no-pinned-deps
        env:
          GITHUB_TOKEN: ${{ secrets.SF_CLI_BOT_GITHUB_TOKEN }}
